<!DOCTYPE HTML>
<html lang="en">

<head>
	<title>clannad_side_stories</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width; initial-scale=1.0; maximum-scale=1.0; user-scalable=0;" />
	<style type="text/css">
		body {
			background-color: #ccc;
			background: url(images/clannad.jpg) repeat;
			margin: 0px;
			overflow: hidden;
			background-size: cover;
		}
		
		div {
			opacity: 0.8;
		}
		
		canvas {
			display: block;	
		}
		#one {
			background-color: #540505;
			font-size: 40px;
		}
	</style>
</head>

<body onLoad="init()">
	<p id="one">你好</p>
	<script>
	var axis = Number(localStorage.getItem('axis')) || 1;
	var b = Number(localStorage.getItem('b', b)) || 2;
	var maxp = 500; //max particles
	var speed = Number(localStorage.getItem('speed')) || 33;
	var maxs = Number(localStorage.getItem('maxs')) || 40;
	var add = Number(localStorage.getItem('add'));
	var angle = Number(localStorage.getItem('angle')) || 0;
	var particles = [];
	var particleImage = new Image();
	var imageElement = document.getElementsByTagName('body')[0];
	var imagesrc = localStorage.getItem('imagesrc') || "images/particleImage.png";
	var backsrc = localStorage.getItem('backsrc') || 'url(' + 'images/clannad.jpg' + ')';
	var movement;
	var bSize = localStorage.getItem('bSize');
	imageElement.style.backgroundSize = bSize;
	imageElement.style.backgroundImage = backsrc;
	particleImage.src = imagesrc;
		
			window.wallpaperPropertyListener = {
				applyUserProperties: function (properties) {
					
					//movement properties
					if (properties.particleAngle){
						properties.particleAngle.value ? add = 0.01 : add = 0;
					}
					
					//image properties
					if (properties.customimage) {
						backsrc = 'url(' + 'file:///' + properties.customimage.value + ')';
						localStorage.setItem('backsrc', backsrc);
						imageElement.style.backgroundImage = backsrc; 
					}
					if (properties.customSize) {
						bSize = properties.customSize.value;
						imageElement.style.backgroundSize = bSize;
					}
					if (properties.customParticle) {
						imagesrc = 'file:///' + properties.customParticle.value;
						localStorage.setItem('imagesrc', imagesrc);
						particleImage.src = imagesrc;
					}
					if (properties.refresh){
						if (properties.refresh.value) {
							location.reload();
						}
					}
					
					
					if (properties.originalParticle) {
						if(properties.originalParticle.value){
							particleImage.src = "images/particleImage.png";
							properties.customParticle.value = "";
							imagesrc = "";
							localStorage.setItem('imagesrc', imagesrc);
						} 
						else{
							particleImage.src = imagesrc;
						}

					}
					if (properties.originalBackground){
						if(properties.originalBackground.value){
							imageElement.style.backgroundImage = 'url(' + 'images/clannad.jpg' + ')';
							properties.customimage.value = "";
							backsrc = "";
							localStorage.setItem('backsrc', backsrc);
						} 
						else{
							imageElement.style.backgroundImage = 'url(' + 'file:///' + backsrc + ')';
						}
					}
					
					if (properties.originalMovement){
						if (properties.originalMovement.value){
							axis = -1;
							b = -2;
							localStorage.setItem('b', b);
							localStorage.setItem('axis', axis);
						}
						else{
							axis = 1;
							b = 2;
							localStorage.setItem('b', b);
							localStorage.setItem('axis', axis);
						}
					}
					
					if (properties.acustomNumber){
						maxp = properties.acustomNumber.value;
					}
					if (properties.acustomSize){
						localStorage.setItem('maxs', properties.acustomSize.value);
					}
					if (properties.acustomSpeed){
						localStorage.setItem('speed', properties.acustomSpeed.value);

					}
					can.clearRect(0, 0, canvas.width, canvas.height);

				}
		};
	
	function init(){
		var canvas = document.getElementById("canvas");
		var can = canvas.getContext("2d");

		//canvas dimensions
		var W = window.innerWidth;
		var H = window.innerHeight;
		canvas.width = W;
		canvas.height = H;

		for(var i = 0; i < maxp; i++)
		{
					particles.push({
						x: Math.random()*W, //x-coordinate
						y: Math.random()*H, //y-coordinate
						r: Math.random()*4+1, //radius
						d: Math.random()*maxp, //density
						w: Math.random()*maxs
					})
		}
		
		function draw()
		{
			can.clearRect(0, 0, W, H);
			can.beginPath();
			for(var i = 0; i < maxp; i++)
			{
				var p = particles[i];
				can.drawImage(particleImage, p.x, p.y, p.w, p.w);
			}
			can.fill();
			update();
		}
		
		function update()
		{
				angle += add;	
				localStorage.setItem('angle', angle);
				for(var i = 0; i < maxp; i++)
				{
					var p = particles[i];
					p.y += Math.cos(angle+p.d) + axis + p.r/b;
					p.x += Math.sin(angle) * 2;

					if(p.x > W+5 || p.x < -5 || p.y < -H || p.y > H)
					{
						if(i%3> 0 && axis == -1) 
						{
							particles[i] = {x: Math.random()*W, y: H-5, r: p.r, d: p.d, w: p.w};
						}
						else if(i%3> 0 && axis == 1) 
						{
							particles[i] = {x: Math.random()*W, y: -10, r: p.r, d: p.d, w: p.w};
						}
						else
						{
							if(Math.sin(angle) > 0)
							{
								particles[i] = {x: -5, y: Math.random()*H, r: p.r, d: p.d, w: p.w};
							}
							else
							{
								particles[i] = {x: W+5, y: Math.random()*H, r: p.r, d: p.d, w: p.w};
							}
						}
					}
				}
		}
		
		setInterval(draw, speed);
}

</script>
<canvas id="canvas"></canvas>
</body>

</html>